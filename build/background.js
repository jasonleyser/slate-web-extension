!function(){const e="https://slate.host",a=async()=>new Promise(((a,t)=>{chrome.cookies.get({url:e,name:"WEB_SERVICE_SESSION_KEY"},(e=>{chrome.runtime.lastError?t(chrome.runtime.lastError):a(e)}))})),t=async()=>{let t,r;try{if(t=await a(),!t)return;r=await fetch(`${e}/api/extension/get-api-keys`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({data:{token:t.value}})})}catch(e){return}return(await r.json()).data[0].key},r=async a=>{const r=await t();let n;try{n=await fetch(`${e}/api/v3/create-link`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:r},body:JSON.stringify({data:{url:a.url}})})}catch(e){console.log(e)}const s=await n.json();if(console.log("upload data: ",s),"LINK_DUPLICATE"!==s.decorator)if("SERVER_CREATE_LINK_FAILED"!==s.decorator&&!0!==s.error){if(!a.background)return chrome.tabs.sendMessage(parseInt(a.tab),{run:"UPLOAD_DONE",data:s.data[0]}),s.data[0]}else chrome.tabs.sendMessage(parseInt(a.tab),{run:"UPLOAD_FAIL"});else chrome.tabs.sendMessage(parseInt(a.tab),{run:"UPLOAD_DUPLICATE",data:s.data[0]})};handleSaveImage=async e=>{const a=await t(),r=`${Constants.uri.upload}/api/v3/public/upload-by-url`;let n;try{n=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:a},body:JSON.stringify({data:{url:e.url,filename:e.url}})})}catch(e){console.log(e)}return await n.json()};const n=(e,a)=>RegExp(e.join("|")).exec(a),s=async r=>{let n;try{n=await a()}catch(e){return void setTimeout((()=>{chrome.tabs.sendMessage(r.id,{run:"AUTH_REQ"})}),1e3)}if(null!==n){let a=await t(),n=await(async a=>{let t;try{t=await fetch(`${e}/api/v3/get`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:a.key}})}catch(e){console.log(e)}if(!t)return;const r=await t.json();return r.error&&console.log(r),r.user})({key:a}),s=await(async a=>{let t;try{t=await fetch(`${e}/api/extension/check-link`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:a.apiKey},body:JSON.stringify({data:{url:a.tab}})})}catch(e){console.log(e)}return await t.json()})({apiKey:a,tab:r.url});return setTimeout((()=>{chrome.tabs.sendMessage(r.id,{run:"CHECK_LINK",data:s,user:n})}),1e3),{data:s,user:n,tab:r.id}}setTimeout((()=>{chrome.tabs.sendMessage(r.id,{run:"AUTH_REQ"})}),1e3)};chrome.action.onClicked.addListener((async e=>{chrome.tabs.sendMessage(e.id,{run:"LOAD_APP",type:"LOADER_MAIN",tabId:e.id}),await s(e)})),chrome.commands.onCommand.addListener((async(a,t)=>{if("open-app"==a&&(chrome.tabs.sendMessage(t.id,{run:"LOAD_APP",type:"LOADER_MAIN"}),await s(t)),"open-slate"==a&&chrome.tabs.create({url:`${e}/_/data&extension=true&id=${t.id}`}),"direct-save"==a){let e=await s(t);e&&e.user?(chrome.tabs.sendMessage(t.id,{run:"LOAD_APP",type:"LOADER_MINI"}),chrome.tabs.sendMessage(parseInt(t.id),{run:"OPEN_LOADING"}),await r({url:t.url,tab:t.id})):chrome.tabs.sendMessage(t.id,{run:"LOAD_APP",type:"LOADER_MAIN"})}})),chrome.runtime.onMessage.addListener((async(a,t,n)=>{"GO_BACK"===a.type&&(chrome.tabs.update(parseInt(a.id),{highlighted:!0}),chrome.tabs.remove(parseInt(t.tab.id))),"SAVE_LINK"===a.type&&(chrome.tabs.sendMessage(parseInt(t.tab.id),{run:"OPEN_LOADING"}),await r({url:t.url,tab:t.tab.id})),"CHECK_LOGIN"!==a.type?"SIGN_OUT"!==a.type||await(async()=>new Promise(((a,t)=>{chrome.cookies.remove({url:e,name:"WEB_SERVICE_SESSION_KEY"},(e=>{chrome.runtime.lastError?t(chrome.runtime.lastError):a(e)}))})))():await(async e=>{e&&chrome.cookies.onChanged.addListener((async a=>{if(a.cookie.domain===Constants.uri.domain&&!1===a.removed)return await s(e),chrome.tabs.update(e.id,{highlighted:!0}),void(e=null)}))})(t.tab)})),chrome.tabs.onUpdated.addListener((async(e,a,t)=>{if("complete"==a.status){const e=["slate.host","slate-dev.onrender.com"],a=n(["chrome://","localhost:","cec.cx"],t.url);if(n(e,t.url),a)return}}))}();